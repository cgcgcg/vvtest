#!/usr/bin/env python

import os, sys
import string, re

from testutils import *

rmallfiles()

writefile( "null.xml", """
<rtest name="null">
</rtest>""" )

out,np,nd,nf,nn = run_vvtest()
assert np == 1 and nd == 0 and nf == 0 and nn == 0

platname = platform_name( out )
print "Extracted platname =", platname


# sleep1 should timeout
writefile( "sleep1.xml", '''
<rtest name="sleep1">
  <keywords> fast </keywords>
  <execute>
echo "sleep1 test is sleeping 10 seconds"
sleep 10
  </execute>
  <timeout value="3"/>
</rtest>''')

# sleep2 should not timeout
writefile( "sleep2.xml", '''
<rtest name="sleep2">
  <keywords> fast </keywords>
  <execute>
echo "sleep2 test is sleeping 10 seconds"
sleep 10
  </execute>
  <timeout value="3"/>
  <timeout platforms="'''+platname+'''" value="0"/>
</rtest>''')

# sleep3 should not timeout
writefile( "sleep3.xml", '''
<rtest name="sleep3">
  <keywords> fast </keywords>
  <execute>
echo "sleep3 test is sleeping 10 seconds"
sleep 10
  </execute>
  <timeout value="3"/>
  <timeout platforms="'''+platname+'''" value="15"/>
</rtest>''')

out,np,nd,nf,nn = run_vvtest()
assert np == 2 and nd == 0 and nf == 0 and nn == 0
assert numtimeout(out) == 1

out,np,nd,nf,nn = run_vvtest( '-wT 1.5' )
assert np == 1 and nd == 0 and nf == 0 and nn == 0
assert numtimeout(out) == 3

out,np,nd,nf,nn = run_vvtest( '-wT 20' )
assert np == 4 and nd == 0 and nf == 0 and nn == 0
assert numtimeout(out) == 0


########################################################################

if platname == 'Linux' or platname == 'iDarwin':
  
  rmallfiles()
  
  # same thing but using pipeline mode
  
  writefile( "null.xml", """
  <rtest name="null">
  </rtest>""" )
  
  out,np,nd,nf,nn = run_vvtest( '--pipeline' )
  assert np == 1 and nd == 0 and nf == 0 and nn == 0
  
  # sleep1 should timeout
  writefile( "sleep1.xml", '''
  <rtest name="sleep1">
    <keywords> fast </keywords>
    <execute>
  echo "sleep1 test is sleeping 10 seconds"
  sleep 10
    </execute>
    <timeout value="3"/>
  </rtest>''')
  
  # sleep2 should not timeout
  writefile( "sleep2.xml", '''
  <rtest name="sleep2">
    <keywords> fast </keywords>
    <execute>
  echo "sleep2 test is sleeping 10 seconds"
  sleep 10
    </execute>
    <timeout value="3"/>
    <timeout platforms="'''+platname+'''" value="0"/>
  </rtest>''')
  
  # sleep3 should not timeout
  writefile( "sleep3.xml", '''
  <rtest name="sleep3">
    <keywords> fast </keywords>
    <execute>
  echo "sleep3 test is sleeping 10 seconds"
  sleep 10
    </execute>
    <timeout value="3"/>
    <timeout platforms="'''+platname+'''" value="15"/>
  </rtest>''')
  
  out,np,nd,nf,nn = run_vvtest( '--pipeline' )
  assert np == 2 and nd == 0 and nf == 0 and nn == 0
  assert numtimeout(out) == 1
  
  out,np,nd,nf,nn = run_vvtest( '--pipeline -wT 1.5' )
  assert np == 1 and nd == 0 and nf == 0 and nn == 0
  assert numtimeout(out) == 3
  
  out,np,nd,nf,nn = run_vvtest( '--pipeline -wT 20' )
  assert np == 4 and nd == 0 and nf == 0 and nn == 0
  assert numtimeout(out) == 0
