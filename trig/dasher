#!/usr/bin/python

import sys
sys.dont_write_bytecode = True
sys.excepthook = sys.__excepthook__
import os
import getopt

import dasherlib


help_dasher = \
"""
SYNOPSIS
    Create static web pages from vvtest results sent to a Git repository.

USAGE:
    dasher --gitlab <project URL> <filename>

OPTIONS:
    --title <string> : sets the title on the landing page (the summary page)
"""


def main():
    ""
    optL,argL = getopt.getopt( sys.argv[1:], 'h',
                               ['help','gitlab=','title='] )

    optD = {}
    for n,v in optL:
        if n == '-h' or n == '--help':
            print3( help_dasher.strip() )
            return
        optD[n] = v

    if len(argL) == 0:
        errorexit( 'no output path given' )

    if '--gitlab' not in optD:
        errorexit( 'the --gitlab option must be given' )

    giturl = optD['--gitlab']
    pathname = argL[0]

    dash = dasherlib.DashboardCreator( giturl )
    dash.readResults()
    dash.writePages( pathname, optD.get( '--title', None ) )


def print3( *args ):
    ""
    sys.stdout.write( ' '.join( [ str(arg) for arg in args ] ) + '\n' )
    sys.stdout.flush()


def errorexit( *args ):
    ""
    err = '*** dasher error: '+' '.join( [ str(arg) for arg in args ] )
    sys.stderr.write( err + '\n' )
    sys.stderr.flush()
    sys.exit(1)


####################################################################

main()
