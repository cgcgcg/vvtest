#!/usr/bin/env python

# Copyright 2018 National Technology & Engineering Solutions of Sandia, LLC
# (NTESS). Under the terms of Contract DE-NA0003525 with NTESS, the U.S.
# Government retains certain rights in this software.

#RUNTEST:

import sys
sys.dont_write_bytecode = True
sys.excepthook = sys.__excepthook__
import os
import time
import getopt


# this will os.chdir() to a subdirectory
from testutils import *

# the module being tested
import kerberos

from command import Command

mydir = os.path.dirname( os.path.abspath( sys.argv[0] ) )
kerbfile = os.path.join( os.path.dirname(mydir), 'kerberos.py' )


def main():


    optL,argL = getopt.getopt( sys.argv[1:], '' )

    if ('-s','') in optL:
        global use_real_ssh
        use_real_ssh = True

    if len(argL) == 0:
        argL = """set_ticket init_ticket destroy_ticket renew_ticket
                  man_page
               """.split()

    savedir = os.getcwd()
    for func in argL:
        os.chdir( savedir )
        rmallfiles()

        os.environ[ 'COMMAND_DRYRUN' ] = ''

        time.sleep(1)
        print3( '====> ', func )
        eval( func+'()' )


######################################################################

def set_ticket():
    """
    the set_ticket function sets the KRB5CCNAME environ variable
    """
    if 'KRB5CCNAME' in os.environ:
        os.environ.pop( 'KRB5CCNAME' )

    kerberos.set_ticket()

    assert 'KRB5CCNAME' in os.environ


def init_ticket():
    ""
    kerberos.init_ticket( echo='none' )
    kerberos.init_ticket()


def destroy_ticket():
    ""
    kerberos.destroy_ticket( echo='none' )
    kerberos.destroy_ticket()


def renew_ticket():
    ""
    kerberos.renew_ticket( echo='none' )
    kerberos.renew_ticket()


def man_page():
    ""
    os.environ.pop( 'COMMAND_DRYRUN' )
    Command( '$kerbfile -h' ).run( raise_on_error=True )
    Command( '$kerbfile --help' ).run( raise_on_error=True )


######################################################################

main()
