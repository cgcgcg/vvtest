#!/usr/bin/env python
#RUNTEST:

import sys
sys.dont_write_bytecode = True
sys.excepthook = sys.__excepthook__
import os
import glob
import unittest
import time

import testutils as util
from testutils import print3

import TestSpecCreator as creator
from RuntimeConfig import RuntimeConfig
from TestList import DependencyPatternMap
from TestSpec import TestSpec

# magic: if the dependencies already ran and you just want to run the
#        analyze test again, the DEPDIRS is not going to be correct
#  question: would you want to apply the blocking check against the deps
#            again?

class dependency_information( unittest.TestCase ):

    def setUp(self):
        util.setup_test()

    def test_the_dependency_dirs_are_available(self):
        ""
        util.writescript( 'testX.vvt', """
            #!/usr/bin/env python
            #VVT: depends on : testY
            import os
            import vvtest_util as vvt
            assert os.path.isdir( vvt.TESTROOT )
            assert len( vvt.DEPDIRS ) == 1
            yfile = os.path.join( vvt.DEPDIRS[0], 'Y.out' )
            assert os.path.exists( yfile )
            """ )
        util.writescript( 'testY.vvt', """
            #!/usr/bin/env python
            fp = open( 'Y.out', 'w' )
            fp.close()
            """ )
        time.sleep(1)

        vrun = util.vvtestRunner( '-N 4' )
        assert vrun.num_pass == 2

        util.remove_results()
        cmd = '--plat '+util.core_platform_name()+' --batch -N 4'
        vrun = util.vvtestRunner( cmd )
        assert vrun.num_pass == 2

    def test_deps_work_with_bash(self):
        ""
        util.writescript( 'testX.vvt', """
            #!/bin/sh
            #VVT: depends on : testY
            source ./vvtest_util.sh
            [ -e $TESTROOT ] || exit 1
            yfile="$DEPDIRS/Y.out"
            cat $yfile || exit 1
            """ )
        util.writescript( 'testY.vvt', """
            #!/bin/sh
            touch Y.out
            """ )
        time.sleep(1)

        vrun = util.vvtestRunner( '-N 4' )
        assert vrun.num_pass == 2

        util.remove_results()
        cmd = '--plat '+util.core_platform_name()+' --batch -N 4'
        vrun = util.vvtestRunner( cmd )
        assert vrun.num_pass == 2

    def test_multiple_depdirs(self):
        ""
        util.writescript( 'testX.vvt', """
            #!/usr/bin/env python
            #VVT: depends on : te*Y
            #VVT: depends on : t*tZ
            import os, glob
            import vvtest_util as vvt
            assert len( vvt.DEPDIRS ) == 2

            fL1 = glob.glob( os.path.join( vvt.DEPDIRS[0], '*.out' ) )
            assert len(fL1) == 1

            fL2 = glob.glob( os.path.join( vvt.DEPDIRS[1], '*.out' ) )
            assert len(fL2) == 1

            assert len( vvt.DEPDIRS ) == 2
            if 'testY' in vvt.DEPDIRS[0]:
                vvt.DEPDIRMAP['te*Y'] == vvt.DEPDIRS[0]
                vvt.DEPDIRMAP['t*tZ'] == vvt.DEPDIRS[1]
            else:
                vvt.DEPDIRMAP['te*Y'] == vvt.DEPDIRS[1]
                vvt.DEPDIRMAP['t*tZ'] == vvt.DEPDIRS[0]
            """ )
        util.writescript( 'testY.vvt', """
            #!/usr/bin/env python
            fp = open( 'Y.out', 'w' )
            fp.close()
            """ )
        util.writescript( 'testZ.vvt', """
            #!/usr/bin/env python
            fp = open( 'Z.out', 'w' )
            fp.close()
            """ )
        time.sleep(1)

        vrun = util.vvtestRunner( '-N 4' )
        assert vrun.num_pass == 3

        util.remove_results()
        cmd = '--plat '+util.core_platform_name()+' --batch -N 4'
        vrun = util.vvtestRunner( cmd )
        assert vrun.num_pass == 3

    def test_depdirs_in_subdirs(self):
        ""
        util.writescript( 'tsrc/testX.vvt', """
            #!/usr/bin/env python
            #VVT: depends on : sub1/testY
            #VVT: depends on : sub2/testZ
            import os, glob
            import vvtest_util as vvt
            assert len( vvt.DEPDIRS ) == 2

            fL = glob.glob( os.path.join( vvt.DEPDIRS[0], '*.out' ) )
            assert len(fL) == 1

            fL = glob.glob( os.path.join( vvt.DEPDIRS[1], '*.out' ) )
            assert len(fL) == 1
            """ )
        util.writescript( 'tsrc/sub1/testY.vvt', """
            #!/usr/bin/env python
            fp = open( 'Y.out', 'w' )
            fp.close()
            """ )
        util.writescript( 'tsrc/sub2/testZ.vvt', """
            #!/usr/bin/env python
            fp = open( 'Z.out', 'w' )
            fp.close()
            """ )
        os.mkdir( 'rdir1' )
        os.mkdir( 'rdir2' )
        time.sleep(1)

        opt = '--plat '+util.core_platform_name() + ' '

        vrun = util.vvtestRunner( opt+'-N 4 ../tsrc', directory='rdir1' )
        assert vrun.num_pass == 3

        tdir = vrun.testdir

        cmd = opt+' --batch -N 4 ../tsrc'
        vrun = util.vvtestRunner( cmd, directory='rdir2' )
        assert vrun.num_pass == 3
        testrootdir2 = os.path.join( 'rdir2', vrun.testdir )

        vrun = util.vvtestRunner( opt+'-R -N 4', directory='rdir2/'+tdir )
        assert vrun.num_pass == 3
        testrootdir1 = vrun.testdir

        cmd = opt+' -R --batch -N 4'
        vrun = util.vvtestRunner( cmd, directory='rdir1/'+tdir )
        assert vrun.num_pass == 3

    def test_depdirs_in_subdirs_of_a_subdir(self):
        ""
        util.writescript( 'tsrc/topdir/testX.vvt', """
            #!/usr/bin/env python
            #VVT: depends on : sub1/testY
            #VVT: depends on : sub2/testZ
            import os, glob
            import vvtest_util as vvt
            assert len( vvt.DEPDIRS ) == 2

            fL = glob.glob( os.path.join( vvt.DEPDIRS[0], '*.out' ) )
            assert len(fL) == 1

            fL = glob.glob( os.path.join( vvt.DEPDIRS[1], '*.out' ) )
            assert len(fL) == 1
            """ )
        util.writescript( 'tsrc/topdir/sub1/testY.vvt', """
            #!/usr/bin/env python
            fp = open( 'Y.out', 'w' )
            fp.close()
            """ )
        util.writescript( 'tsrc/topdir/sub2/testZ.vvt', """
            #!/usr/bin/env python
            fp = open( 'Z.out', 'w' )
            fp.close()
            """ )
        time.sleep(1)

        opt = '--plat '+util.core_platform_name() + ' '

        vrun = util.vvtestRunner( opt+'-N 4 tsrc' )
        assert vrun.num_pass == 3


############################################################################

util.run_test_cases( sys.argv, sys.modules[__name__] )
