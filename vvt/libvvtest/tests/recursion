#!/usr/bin/env python

# Copyright 2018 National Technology & Engineering Solutions of Sandia, LLC
# (NTESS). Under the terms of Contract DE-NA0003525 with NTESS, the U.S.
# Government retains certain rights in this software.

#RUNTEST:

import sys
sys.dont_write_bytecode = True
sys.excepthook = sys.__excepthook__
import os
import glob
import time
import unittest

import testutils as util
from testutils import print3


class tests_that_run_vvtest( unittest.TestCase ):

    def setUp(self):
        util.setup_test()

    def test_a_test_that_runs_vvtest(self):
        ""
        plat = util.core_platform_name()

        util.writefile( 'outside.py.vvt', """
            import os
            import vvtest_util as vvt
            import script_util as util

            fp = open( 'inside.py.vvt', 'w' )
            fp.write( "import vvtest_util as vvt"+os.linesep )
            fp.write( "fp = open( 'hello.txt', 'w' )"+os.linesep )
            fp.write( "fp.write( 'world'+os.linesep )"+os.linesep )
            fp.write( "fp.close()"+os.linesep )
            fp.close()

            util.runcmd( '"""+util.vvtest+""" -k inside.py --plat """+plat+"""' )
            """ )
        time.sleep(1)

        self.a_test_that_runs_vvtest( '--plat '+plat )
        self.a_test_that_runs_vvtest( '--plat '+plat+' --batch' )

    def a_test_that_runs_vvtest(self, opt):
        ""
        util.remove_results()

        out,np,nd,nf,nn = util.run_vvtest( opt )
        assert np == 1 and nd == 0 and nf == 0 and nn == 0

        tdir = util.results_dir()
        bdir = os.path.basename( tdir )

        fL = glob.glob( tdir+'/outside.py/'+bdir+'/inside.py/hello.txt' )
        assert len(fL) == 1


########################################################################

util.run_test_cases( sys.argv, sys.modules[__name__] )
